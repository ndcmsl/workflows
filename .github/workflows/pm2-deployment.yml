name: "PM2 Deployment"
on:
  workflow_call:  
    secrets:
      host:
        description: "Remote host"
        required: true
      username:
        description: "Username to login"
        required: true
      password:
        description: "SSH password"
        required: true
    inputs:
      port:
        type: number
        description: "SSH port"
        required: false
        default: 22
      automatic-pre-deploy:
        type: boolean
        description: "Deploy automatically"
        required: false
        default: true
      yarn:
        type: boolean
        description: "Do you want to use yarn?"
        required: false
        default: false
      build:
        type: boolean
        description: "Do you want to build your typescript code?"
        required: false
        default: false
      reload: 
        type: boolean
        description: "Use reload instead of restart"
        required: false
        default: false

jobs:
  deploy:
    env:
      HOST: ${{ secrets.host }}
      USERNAME: ${{ secrets.username }}
      PORT: ${{ inputs.port }}
      PASSWORD: ${{ secrets.password }}

    runs-on: self-hosted
    steps:
      - name: Set repository name
        run: |
          REPO_NAME=$(echo ${{ github.repository }} | cut -d "/" -f 2)
          echo REPO_NAME=$REPO_NAME >> $GITHUB_ENV
          echo REMOTE_PATH=/deployment/$REPO_NAME >> $GITHUB_ENV
      - uses: actions/checkout@v2
      
      - name: Copy repository contents
        uses: appleboy/scp-action@master
        with:
          source: "."
          target: ${{ inputs.remote-path }}
          
      - name: Run npm clean-install
        if: ${{ inputs.automatic-pre-deploy == true && inputs.yarn == false }}
        uses: appleboy/ssh-action@master
        with:
          script: cd ${{ env.REMOTE_PATH }} && npm ci
          
      - name: Run yarn install
        if: ${{ inputs.automatic-pre-deploy == true && inputs.yarn == true }}
        uses: appleboy/ssh-action@master
        with:
          script: cd ${{ env.REMOTE_PATH }} && yarn install
        
      - name: Build project
        if: ${{ inputs.build == true }}
        uses: appleboy/ssh-action@master
        with:
          script: cd ${{ env.REMOTE_PATH }} && npm run build

      - name: Restart remote application
        if: ${{ inputs.reload == false }}
        uses: appleboy/ssh-action@master
        with:
          script: pm2 restart ${{ env.REPO_NAME }}
          
      - name: Reload remote application
        if: ${{ inputs.reload == true }}
        uses: appleboy/ssh-action@master
        with:
          script: pm2 reload ${{ env.REPO_NAME }}