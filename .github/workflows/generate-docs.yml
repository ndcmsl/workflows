###############################################################################
# generate-docs.yml  â€”  Reusable workflow: documentaciÃ³n de release con IA
# ---------------------------------------------------------------------------
# Repo: ndcmsl/workflows
#
# Genera documentaciÃ³n automÃ¡tica de release a partir del historial de commits
# y diffs de cÃ³digo, usando la API de OpenAI.
#
# El script Python vive aquÃ­ (scripts/generate_release_docs.py) para no
# exponer cÃ³digo interno en repos de producto/cliente.
#
# El repo que llama a este workflow solo necesita:
#   - __documentacion/  (carpeta de documentaciÃ³n existente)
#   - Secret OPENAI_API_KEY configurado
#
# Uso desde otro repo:
#   jobs:
#     docs:
#       uses: ndcmsl/workflows/.github/workflows/generate-docs.yml@main
#       secrets:
#         openai_api_key: ${{ secrets.OPENAI_API_KEY }}
#         token: ${{ secrets.GITHUB_TOKEN }}
###############################################################################

name: Generate release docs

on:
  workflow_call:
    secrets:
      openai_api_key:
        description: "API key de OpenAI para generar documentaciÃ³n"
        required: true
      token:
        description: "Token de GitHub con permisos de escritura (contents + pull-requests)"
        required: true
    inputs:
      docs_folder:
        description: "Carpeta de documentaciÃ³n existente en el repo"
        type: string
        required: false
        default: "__documentacion"
      output_folder:
        description: "Subcarpeta de salida para release docs"
        type: string
        required: false
        default: "__documentacion/releases"
      model:
        description: "Modelo de OpenAI a usar"
        type: string
        required: false
        default: "gpt-4o"
      diff_paths:
        description: "Paths a incluir en el diff (espacio-separados)"
        type: string
        required: false
        default: "core/ override/ classes/ controllers/ themes/ config/ modules/ __documentacion/"
      python_version:
        description: "VersiÃ³n de Python"
        type: string
        required: false
        default: "3.12"
      pr_base_branch:
        description: "Rama base para el PR de documentaciÃ³n"
        type: string
        required: false
        default: "master"

jobs:
  generate-docs:
    name: Generate & PR release docs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # ---------------------------------------------------------------
      # 1. Checkout del repo que llama (Prestashop) â€” con historial
      # ---------------------------------------------------------------
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.token }}
          path: repo

      # ---------------------------------------------------------------
      # 2. Checkout del repo de workflows (para obtener el script)
      # ---------------------------------------------------------------
      - name: Checkout workflows scripts
        uses: actions/checkout@v4
        with:
          repository: ndcmsl/workflows
          token: ${{ secrets.token }}
          path: _workflows
          sparse-checkout: scripts

      # ---------------------------------------------------------------
      # 3. Detectar Ãºltimo tag y construir inputs para el script
      # ---------------------------------------------------------------
      - name: Build release notes input
        id: build-input
        working-directory: repo
        run: |
          set -euo pipefail

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "LAST_TAG=$LAST_TAG" >> "$GITHUB_ENV"

          if [ -n "$LAST_TAG" ]; then
            RANGE="${LAST_TAG}..HEAD"
            echo "ðŸ“Œ Ãšltimo tag encontrado: $LAST_TAG"
          else
            # Sin tags: usar los Ãºltimos 100 commits
            RANGE="HEAD~100..HEAD"
            echo "âš  Sin tags â€” usando Ãºltimos 100 commits"
          fi

          echo "RANGE=$RANGE" >> "$GITHUB_ENV"

          # Lista de commits
          git log ${RANGE} --pretty=format:"- %s (%h) [%an]" \
            > /tmp/commits.txt 2>/dev/null || true

          COMMIT_COUNT=$(wc -l < /tmp/commits.txt || echo "0")
          echo "ðŸ“ Commits encontrados: $COMMIT_COUNT"

          if [ "$COMMIT_COUNT" -eq "0" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "âš  Sin commits nuevos. Saltando generaciÃ³n."
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Diff stat (resumen)
          git diff --stat ${RANGE} > /tmp/diff_stat.txt 2>/dev/null || true

          # Diff de cÃ³digo (solo paths relevantes, limitado a 500KB)
          git diff ${RANGE} -- ${{ inputs.diff_paths }} \
            | head -c 500000 \
            > /tmp/diff.txt 2>/dev/null || true

          echo "ðŸ“Š TamaÃ±o del diff: $(wc -c < /tmp/diff.txt) bytes"

      # ---------------------------------------------------------------
      # 4. Setup Python + dependencias
      # ---------------------------------------------------------------
      - name: Setup Python
        if: steps.build-input.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies
        if: steps.build-input.outputs.skip != 'true'
        run: pip install --quiet openai

      # ---------------------------------------------------------------
      # 5. Ejecutar script de generaciÃ³n (script del repo workflows,
      #    datos del repo del caller)
      # ---------------------------------------------------------------
      - name: Generate documentation with AI
        if: steps.build-input.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
        run: |
          python _workflows/scripts/generate_release_docs.py \
            --commits /tmp/commits.txt \
            --diff-stat /tmp/diff_stat.txt \
            --diff /tmp/diff.txt \
            --docs-dir "repo/${{ inputs.docs_folder }}" \
            --out-dir "repo/${{ inputs.output_folder }}" \
            --model "${{ inputs.model }}"

      # ---------------------------------------------------------------
      # 6. Crear PR con la documentaciÃ³n generada (sobre el repo caller)
      # ---------------------------------------------------------------
      - name: Create Pull Request
        if: steps.build-input.outputs.skip != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.token }}
          path: repo
          commit-message: "docs: actualizaciÃ³n automÃ¡tica de documentaciÃ³n de release"
          title: "docs: actualizaciÃ³n automÃ¡tica de documentaciÃ³n"
          body: |
            ## ðŸ“„ DocumentaciÃ³n de release generada automÃ¡ticamente

            Esta PR contiene documentaciÃ³n generada por IA tras los Ãºltimos cambios en `${{ inputs.pr_base_branch }}`.

            **Rango analizado**: `${{ env.RANGE }}`
            **Ãšltimo tag**: `${{ env.LAST_TAG || 'ninguno' }}`
            **Modelo usado**: `${{ inputs.model }}`

            ### Ficheros modificados
            - `${{ inputs.output_folder }}/` â€” nueva release doc
            - `${{ inputs.docs_folder }}/CHANGELOG_AI.md` â€” changelog acumulativo
            - `${{ inputs.docs_folder }}/00_INDICE_DOCUMENTACION.md` â€” Ã­ndice actualizado

            ---
            > âš  **Revisar antes de mergear**: la documentaciÃ³n es generada por IA y puede
            > contener imprecisiones. Verificar que los cambios descritos coinciden con
            > lo realmente implementado.
          branch: docs/auto-release-update
          base: ${{ inputs.pr_base_branch }}
          labels: |
            documentation
            automated
          delete-branch: true
