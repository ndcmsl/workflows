###############################################################################
# generate-docs.yml  ‚Äî  Reusable workflow: documentaci√≥n de release con IA
# ---------------------------------------------------------------------------
# Repo: ndcmsl/workflows
#
# Genera documentaci√≥n autom√°tica de release a partir del historial de commits
# y diffs de c√≥digo, usando la API de OpenAI.
#
# El script Python vive aqu√≠ (scripts/generate_release_docs.py) para no
# exponer c√≥digo interno en repos de producto/cliente.
#
# IMPORTANTE: La documentaci√≥n se commitea directamente en la rama
# target_branch (por defecto develop), NO se crea PR.
#
# Fuente de verdad para el diff: git diff --name-only entre el √∫ltimo tag
# y HEAD. Solo se documentan los ficheros que aparecen ah√≠.
#
# El repo que llama a este workflow solo necesita:
#   - __documentacion/  (carpeta de documentaci√≥n existente)
#   - Secrets: OPENAI_API_KEY y un token con permisos de escritura
#
# Uso desde otro repo:
#   jobs:
#     docs:
#       uses: ndcmsl/workflows/.github/workflows/generate-docs.yml@main
#       secrets:
#         openai_api_key: ${{ secrets.OPENAI_API_KEY }}
#         token: ${{ secrets.GH_TOKEN }}
###############################################################################

name: Generate release docs

on:
  workflow_call:
    secrets:
      openai_api_key:
        description: "API key de OpenAI para generar documentaci√≥n"
        required: true
      token:
        description: "Token de GitHub con permisos de escritura"
        required: true
    inputs:
      docs_folder:
        description: "Carpeta de documentaci√≥n existente en el repo"
        type: string
        required: false
        default: "__documentacion"
      output_folder:
        description: "Subcarpeta de salida para release docs"
        type: string
        required: false
        default: "__documentacion/releases"
      model:
        description: "Modelo de OpenAI a usar"
        type: string
        required: false
        default: "gpt-4o"
      diff_paths:
        description: "Paths a incluir en el diff (espacio-separados)"
        type: string
        required: false
        default: "core/ override/ classes/ controllers/ themes/ config/ modules/"
      python_version:
        description: "Versi√≥n de Python"
        type: string
        required: false
        default: "3.12"
      target_branch:
        description: "Rama donde se commitea la documentaci√≥n generada"
        type: string
        required: false
        default: "develop"

jobs:
  generate-docs:
    name: Generate & commit release docs
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ---------------------------------------------------------------
      # 1. Checkout del repo que llama (Prestashop) ‚Äî con historial
      #    Se clona sobre target_branch para poder commitear ah√≠
      # ---------------------------------------------------------------
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0
          token: ${{ secrets.token }}
          path: repo

      # ---------------------------------------------------------------
      # 2. Checkout del repo de workflows (para obtener el script)
      # ---------------------------------------------------------------
      - name: Checkout workflows scripts
        uses: actions/checkout@v4
        with:
          repository: ndcmsl/workflows
          token: ${{ secrets.token }}
          path: _workflows
          sparse-checkout: scripts

      # ---------------------------------------------------------------
      # 3. Detectar √∫ltimo tag y construir inputs para el script.
      #    Genera archivo de LISTA EXACTA de ficheros modificados
      #    con git diff --name-only (fuente de verdad).
      # ---------------------------------------------------------------
      - name: Build release notes input
        id: build-input
        working-directory: repo
        run: |
          set -euo pipefail

          # Necesitamos los datos de master para comparar
          git fetch origin master --tags 2>/dev/null || true

          LAST_TAG=$(git describe --tags --abbrev=0 origin/master 2>/dev/null || echo "")
          echo "LAST_TAG=$LAST_TAG" >> "$GITHUB_ENV"

          if [ -n "$LAST_TAG" ]; then
            RANGE="${LAST_TAG}..origin/master"
            echo "üìå √öltimo tag encontrado: $LAST_TAG"
          else
            RANGE="origin/master~100..origin/master"
            echo "‚ö† Sin tags ‚Äî usando √∫ltimos 100 commits de master"
          fi

          echo "RANGE=$RANGE" >> "$GITHUB_ENV"

          # ‚îÄ‚îÄ LISTA EXACTA de ficheros modificados (FUENTE DE VERDAD) ‚îÄ‚îÄ
          git diff --name-only ${RANGE} > /tmp/file_list.txt 2>/dev/null || true

          FILE_COUNT=$(wc -l < /tmp/file_list.txt || echo "0")
          echo "üìÑ Ficheros modificados: $FILE_COUNT"

          if [ "$FILE_COUNT" -eq "0" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "‚ö† Sin ficheros modificados. Saltando generaci√≥n."
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Lista de commits
          git log ${RANGE} --pretty=format:"- %s (%h) [%an]" \
            > /tmp/commits.txt 2>/dev/null || true

          COMMIT_COUNT=$(wc -l < /tmp/commits.txt || echo "0")
          echo "üìù Commits encontrados: $COMMIT_COUNT"

          # Diff stat (resumen)
          git diff --stat ${RANGE} > /tmp/diff_stat.txt 2>/dev/null || true

          # Diff de c√≥digo (solo paths relevantes, limitado a 500KB)
          git diff ${RANGE} -- ${{ inputs.diff_paths }} \
            | head -c 500000 \
            > /tmp/diff.txt 2>/dev/null || true

          echo "üìä Tama√±o del diff: $(wc -c < /tmp/diff.txt) bytes"
          echo "üìã Primeros 20 ficheros modificados:"
          head -20 /tmp/file_list.txt

      # ---------------------------------------------------------------
      # 4. Setup Python + dependencias
      # ---------------------------------------------------------------
      - name: Setup Python
        if: steps.build-input.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies
        if: steps.build-input.outputs.skip != 'true'
        run: pip install --quiet openai

      # ---------------------------------------------------------------
      # 5. Ejecutar script de generaci√≥n (script del repo workflows,
      #    datos del repo del caller)
      # ---------------------------------------------------------------
      - name: Generate documentation with AI
        if: steps.build-input.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
        run: |
          python _workflows/scripts/generate_release_docs.py \
            --commits /tmp/commits.txt \
            --diff-stat /tmp/diff_stat.txt \
            --diff /tmp/diff.txt \
            --file-list /tmp/file_list.txt \
            --docs-dir "repo/${{ inputs.docs_folder }}" \
            --out-dir "repo/${{ inputs.output_folder }}" \
            --model "${{ inputs.model }}"

      # ---------------------------------------------------------------
      # 6. Commit directo a target_branch (develop)
      # ---------------------------------------------------------------
      - name: Commit docs to target branch
        if: steps.build-input.outputs.skip != 'true'
        working-directory: repo
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${{ inputs.docs_folder }}/" "${{ inputs.output_folder }}/" 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "‚Ñπ Sin cambios en documentaci√≥n. Saltando commit."
            exit 0
          fi

          git commit -m "docs: actualizaci√≥n autom√°tica de documentaci√≥n de release [skip ci]"

          # Pull con rebase para incorporar cambios concurrentes en target_branch
          git pull --rebase origin ${{ inputs.target_branch }} || true

          # Reintentar push hasta 3 veces (por si develop avanza durante el rebase)
          for i in 1 2 3; do
            git push origin ${{ inputs.target_branch }} && break
            echo "‚ö† Push fallido (intento $i/3). Reintentando con pull --rebase..."
            sleep 5
            git pull --rebase origin ${{ inputs.target_branch }} || true
          done

          echo "‚úÖ Documentaci√≥n commiteada en ${{ inputs.target_branch }}"
